<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin · Edit Figure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/static/pit-favicon-mark.ico" />
  <link rel="stylesheet" href="/static/style.css?v=brand-9" />
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937; --border:#273549;
      --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --good:#34d399; --bad:#ef4444;
    }
    body{background:linear-gradient(180deg,#0b1220,#0f172a 30%,#0b0f1a);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;min-height:100vh;}
    .container{max-width:1100px;margin:32px auto;padding:0 16px;}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35);overflow:hidden;}
    .header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);}
    .title{font-size:18px;font-weight:700;}
    .subtitle{color:var(--muted);font-size:12px;}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted);}
    .pill.good{color:var(--good);border-color:#14532d;background:rgba(20,83,45,.2);}
    .pill.bad{color:var(--bad);border-color:#7f1d1d;background:rgba(127,29,29,.2);}
    .btn{border:1px solid var(--border);color:var(--text);background:#0e1526;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;}
    .btn:hover{border-color:var(--accent);}
    .btn.primary{background:linear-gradient(180deg,#1a2376,#1e40af);}
    .btn.success{background:linear-gradient(180deg,#0b5f3e,#065f46);}
    .btn.danger{background:linear-gradient(180deg,#7f1d1d,#991b1b);}
    .panel{padding:16px;}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .full{grid-column:1 / -1;}
    input[type="text"],textarea{
      width:100%;background:#0b1220;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;font-size:13px;outline:none;
    }
    textarea{min-height:140px;resize:vertical;}
    .muted{color:var(--muted);font-size:12px;}
    .kicker{color:var(--muted);font-size:12px;margin-bottom:6px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .status{font-size:12px;color:var(--muted);}
    .good{color:var(--good);}
    .bad{color:var(--bad);}
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px;}
    .backlink{text-decoration:none;color:#9fb8ff;}
    .counter{font-size:11px;color:var(--muted);}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Edit Figure</div>
          <div class="subtitle"><a class="backlink" href="/admin/ui">← Back to Admin</a></div>
        </div>
        <div class="row">
          <div id="authStatus" class="pill bad">Signed out</div>
          <div id="adminStatus" class="pill">Admin inactive</div>
          <button class="btn" id="lockAdminBtn">Lock Admin</button>
          <button class="btn danger" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="panel">
        <div class="toolbar">
          <div class="kicker">Sign in</div>
          <div class="row">
            <input id="email" type="text" placeholder="Email" style="width:220px;" />
            <input id="password" type="password" placeholder="Password" style="width:180px;" />
            <button class="btn primary" id="loginBtn">Sign in & Step Up</button>
            <span class="status" id="loginStatus">Waiting…</span>
          </div>
        </div>

        <div class="kicker">Figure basics</div>
        <div class="form">
          <div><input id="figName" type="text" placeholder="Name" /></div>
          <div><input id="figSlug" type="text" placeholder="Slug" /></div>
          <div><input id="figEra" type="text" placeholder="Era" /></div>
          <div><input id="figImage" type="text" placeholder="Image URL" /></div>
          <div class="full" style="display:flex;gap:12px;align-items:flex-start;">
            <img id="figImagePreview" alt="preview" style="width:180px;height:180px;border-radius:12px;border:1px solid var(--border);object-fit:cover;background:#0b1220" />
            <div class="muted">Preview updates as you edit the Image URL.</div>
          </div>
          <div class="full"><input id="figShort" type="text" placeholder="Short summary" /></div>
          <div class="full"><textarea id="figLong" placeholder="Long bio"></textarea></div>
          <div class="full"><input id="figQuote" type="text" placeholder="Quote" /></div>
        </div>

        <div class="kicker" style="margin-top:10px;">Persona Prompt</div>
        <div class="form">
          <div class="full">
            <textarea id="personaPrompt" placeholder="Persona prompt used to steer the figure's voice and behavior."></textarea>
            <div class="row" style="justify-content:space-between;">
              <span class="muted">This text is sent to the model alongside retrieved RAG context.</span>
              <span class="counter" id="personaCount">0 chars</span>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn success" id="saveBtn">Save Changes</button>
          <span class="status" id="saveStatus">Waiting…</span>
        </div>
        
        <div class="kicker" style="margin-top:18px;">RAG / Documents</div>
        <div class="form full">
          <div class="full">
            <div id="dropZone" style="min-height:120px;border:2px dashed var(--border);border-radius:10px;padding:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.01);">
              <div style="text-align:center;">
                <div class="muted">Drag & drop PDF files here, or</div>
                <div style="margin-top:8px;"><input id="fileInput" type="file" multiple accept="application/pdf"/></div>
                <div style="margin-top:8px;"><button class="btn" id="uploadBtn">Upload & Ingest</button></div>
              </div>
            </div>
            <div class="muted" id="uploadStatus" style="margin-top:8px;">No uploads yet.</div>
          </div>
          <div class="full">
            <div class="kicker">Existing Sources</div>
            <div style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px;background:rgba(0,0,0,.02);">
              <table id="ragTable" style="width:100%;border-collapse:collapse;color:var(--text);">
                <thead><tr><th style="text-align:left">ID</th><th style="text-align:left">Source</th><th style="text-align:left">Type</th></tr></thead>
                <tbody id="ragBody"></tbody>
              </table>
            </div>
            <div style="margin-top:8px;">
              <button class="btn" id="ragRefresh">Refresh sources</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const $ = (s) => document.querySelector(s);

  const state = { userToken: null, adminToken: null, password: null };
      const dom = {
        email: $("#email"), password: $("#password"), loginBtn: $("#loginBtn"), loginStatus: $("#loginStatus"),
        authStatus: $("#authStatus"), adminStatus: $("#adminStatus"), lockAdminBtn: $("#lockAdminBtn"), logoutBtn: $("#logoutBtn"),
        figName: $("#figName"), figSlug: $("#figSlug"), figEra: $("#figEra"), figImage: $("#figImage"),
        figShort: $("#figShort"), figLong: $("#figLong"), figQuote: $("#figQuote"),
        personaPrompt: $("#personaPrompt"), personaCount: $("#personaCount"),
        saveBtn: $("#saveBtn"), saveStatus: $("#saveStatus"),
        figImagePreview: $("#figImagePreview"),
      };

      const slug = (location.pathname.split("/").pop() || "").trim();

      function setAuthUI() {
        if (state.userToken) { dom.authStatus.textContent = "Signed in"; dom.authStatus.classList.remove("bad"); dom.authStatus.classList.add("good"); }
        else { dom.authStatus.textContent = "Signed out"; dom.authStatus.classList.add("bad"); dom.authStatus.classList.remove("good"); }
        if (state.adminToken) { dom.adminStatus.textContent = "Admin active"; dom.adminStatus.classList.add("good"); }
        else { dom.adminStatus.textContent = "Admin inactive"; dom.adminStatus.classList.remove("good"); }
        // Disable save when admin isn't active (prevents 401s on PATCH/POST)
        try { dom.saveBtn.disabled = !state.adminToken; } catch(_){}
      }

      async function fetchJSON(path, opts = {}, requireAdmin = false) {
        const headers = { "Content-Type": "application/json", ...(opts.headers || {}) };
        const token = requireAdmin ? state.adminToken : state.userToken;
        if (token) headers["Authorization"] = `Bearer ${token}`;
        const res = await fetch(path, { ...opts, headers });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.detail || res.statusText || "Request failed");
        return data;
      }

      const API = {
        adminLogin: (username, password) =>
          fetchJSON("/auth/admin/login", { method: "POST", body: JSON.stringify({ username, password }) }),
        listFigures: () => fetchJSON("/admin/figures", {}, true),                     // admin list (summary)
        createFigure: (payload) => fetchJSON("/admin/figures", { method: "POST", body: JSON.stringify(payload) }, true),
        updateFigure: (slug, payload) =>                                             // admin update (detail response)
          fetchJSON(`/admin/figures/${encodeURIComponent(slug)}`, { method: "PATCH", body: JSON.stringify(payload) }, true),
        publicFigure: (slug) => fetchJSON(`/figures/${encodeURIComponent(slug)}`),   // public read (if available)
      };

      async function loginAndStepUp() {
        dom.loginStatus.textContent = "Signing in (admin)…";
        const username = dom.email.value.trim();
        const password = dom.password.value;
        if (!username || !password) { dom.loginStatus.innerHTML = `<span class="bad">Email and password required</span>`; return; }
        try {
          const login = await API.adminLogin(username, password);
          if (!login?.admin_access_token || !login?.access_token) throw new Error("Admin login failed");
          state.userToken = login.access_token; state.adminToken = login.admin_access_token; state.password = password; setAuthUI();
          dom.loginStatus.innerHTML = `<span class="good">Admin active</span>`;
          await loadFigure();
        } catch (e) {
          dom.loginStatus.innerHTML = `<span class="bad">${e.message}</span>`;
          state.userToken = null; state.adminToken = null; setAuthUI();
        }
      }

      function lockAdmin(){ state.adminToken = null; setAuthUI(); }
  function logout(){ state.userToken = null; state.adminToken = null; state.password = null; setAuthUI(); }

      function updatePersonaCounter(){ dom.personaCount.textContent = `${(dom.personaPrompt.value || "").length} chars`; }

      async function loadFigure() {
        dom.saveStatus.textContent = "Loading…";
        try {
          if (slug === 'new') {
            // Prepare blank form for creation
            dom.figName.value = ""; dom.figSlug.value = ""; dom.figEra.value = ""; dom.figImage.value = ""; dom.figShort.value = ""; dom.figLong.value = ""; dom.figQuote.value = ""; dom.personaPrompt.value = ""; updatePersonaCounter();
            dom.saveBtn.textContent = 'Create Figure';
            dom.saveStatus.textContent = 'Ready to create';
            return;
          }
          // 1) Get summary from admin list (always available)
          const rows = await API.listFigures();
          const f = rows.find((x) => (x.slug || "") === slug);
          if (!f) throw new Error("Figure not found");
          dom.figName.value = f.name || "";
          dom.figSlug.value = f.slug || "";
          dom.figEra.value = f.era || "";
          dom.figImage.value = f.image_url || "";
          updateImagePreview();
          dom.figShort.value = f.short_summary || "";

          // 2) Try public detail (if router exposes it) to populate long_bio/persona_prompt
          try {
            const pub = await API.publicFigure(slug);
            if (pub?.long_bio != null) dom.figLong.value = pub.long_bio || "";
            if (pub?.persona_prompt != null) dom.personaPrompt.value = pub.persona_prompt || "";
            if (pub?.quote != null) dom.figQuote.value = pub.quote || "";
          } catch { /* ignore if not available */ }

          updatePersonaCounter();
          dom.saveStatus.textContent = "Ready";
        } catch (e) {
          dom.saveStatus.innerHTML = `<span class="bad">${e.message}</span>`;
        }
      }

      function readCookie(name){
        try{
          const m = document.cookie.split('; ').find(row => row.startsWith(name + '='));
          return m ? decodeURIComponent(m.split('=')[1]) : null;
        }catch(_){ return null }
      }

      async function bootstrapAuthFromStorage(){
        try{
          // Prefer sessionStorage (set by ops console), then localStorage, then cookies
          state.userToken = sessionStorage.getItem('user_token')
            || localStorage.getItem('access_token')
            || readCookie('pit_access_token')
            || null;
        }catch(_){ /* noop */ }
        try{
          state.adminToken = sessionStorage.getItem('admin_token')
            || readCookie('pit_admin_token')
            || null;
        }catch(_){ /* noop */ }
        setAuthUI();
        // If no admin token present, redirect to ops console for a single session login.
        if(!state.adminToken){
          // Preserve current target slug for post-login return.
          const slug = (location.pathname.split('/').pop() || '').trim();
          const next = encodeURIComponent(`/admin/figure-ui/${slug}`);
          location.href = `/ops/console?next=${next}`;
          return;
        }
        if(state.userToken){
          try{ await loadFigure(); }catch(_){ /* handled in loadFigure */ }
        }
      }

      async function save() {
        dom.saveStatus.textContent = "Saving…";
        try {
          if (slug === 'new') {
            const payload = {
              id: 0,
              name: dom.figName.value.trim(),
              slug: dom.figSlug.value.trim(),
              short_summary: dom.figShort.value.trim() || null,
              long_bio: dom.figLong.value.trim() || null,
              era: dom.figEra.value.trim() || null,
              image_url: dom.figImage.value.trim() || null,
              quote: dom.figQuote.value.trim() || null,
              persona_prompt: dom.personaPrompt.value || null,
            };
            if (!payload.name || !payload.slug) throw new Error('Name and Slug are required');
            const created = await API.createFigure(payload);
            dom.saveStatus.innerHTML = `<span class="good">Created</span>`;
            // Redirect to real slug page to continue editing
            const newSlug = created?.slug || payload.slug;
            location.href = `/admin/figure-ui/${encodeURIComponent(newSlug)}`;
            return;
          }

          const payload = {};
          if (dom.figName.value.trim())  payload["name"] = dom.figName.value.trim();
          if (dom.figEra.value.trim())   payload["era"] = dom.figEra.value.trim();
          if (dom.figImage.value.trim()) payload["image_url"] = dom.figImage.value.trim();
          if (dom.figShort.value.trim()) payload["short_summary"] = dom.figShort.value.trim();
          if (dom.figLong.value.trim())  payload["long_bio"] = dom.figLong.value.trim();
          if (dom.figQuote.value.trim() || dom.figQuote.value === "") payload["quote"] = dom.figQuote.value;
          payload["persona_prompt"] = dom.personaPrompt.value; // allow empty to clear

          const r = await API.updateFigure(slug, payload);
          // refresh from server response (expects detail with persona_prompt included)
          dom.figName.value = r.name || "";
          dom.figEra.value = r.era || "";
          dom.figImage.value = r.image_url || "";
          updateImagePreview();
          dom.figShort.value = r.short_summary || "";
          dom.figLong.value = r.long_bio || "";
          dom.personaPrompt.value = r.persona_prompt || "";
          dom.figQuote.value = r.quote || "";
          updatePersonaCounter();
          dom.saveStatus.innerHTML = `<span class="good">Saved</span>`;
        } catch (e) {
          dom.saveStatus.innerHTML = `<span class="bad">${e.message}</span>`;
        }
      }

      function updateImagePreview(){
        const url = (dom.figImage.value || '').trim();
        if (!url) { dom.figImagePreview.src = ''; dom.figImagePreview.style.visibility='hidden'; return; }
        dom.figImagePreview.src = url;
        dom.figImagePreview.style.visibility='visible';
      }

      // Wire up
      $("#loginBtn").addEventListener("click", loginAndStepUp);
      $("#lockAdminBtn").addEventListener("click", lockAdmin);
      $("#logoutBtn").addEventListener("click", logout);
      $("#personaPrompt").addEventListener("input", updatePersonaCounter);
  $("#saveBtn").addEventListener("click", save);
  $("#figImage").addEventListener("input", updateImagePreview);

      // Initialize from existing tokens so we don't force a second sign-in if you've already used /ops/console
      bootstrapAuthFromStorage();
      // After authenticating, Save will update existing or create new figures depending on slug.
      // ---------- RAG upload helpers ----------
      async function fetchWithAuth(url, opts = {}, requireAdmin = true) {
        const headers = { ...(opts.headers || {}) };
        const tok = requireAdmin ? state.adminToken : state.userToken;
        if (tok) headers['Authorization'] = `Bearer ${tok}`;
        const res = await fetch(url, { ...opts, headers });
        return res;
      }

      async function uploadFiles() {
        const input = document.getElementById('fileInput');
        const files = input.files || [];
        if (!files.length) { alert('Select at least one PDF file to upload.'); return; }
        document.getElementById('uploadStatus').textContent = 'Uploading…';
        try {
          const fd = new FormData();
          for (const f of files) fd.append('files', f, f.name);
          const q = new URLSearchParams({ figure_slug: slug });
          const res = await fetchWithAuth(`/admin/rag/upload?${q.toString()}`, { method: 'POST', body: fd }, true);
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data?.detail || res.statusText || 'Upload failed');
          }
          const data = await res.json().catch(() => []);
          document.getElementById('uploadStatus').textContent = `Uploaded ${Array.isArray(data) ? data.length : 0} files`;
          await loadRag();
        } catch (e) {
          document.getElementById('uploadStatus').textContent = `Error: ${e.message}`;
        }
      }

      async function loadRag() {
        const body = document.getElementById('ragBody');
        body.innerHTML = '';
        try {
          const q = new URLSearchParams({ figure_slug: slug });
          const res = await fetchWithAuth(`/admin/rag/contexts?${q.toString()}`, {}, true);
          if (!res.ok) throw new Error(res.statusText || 'Failed');
          const rows = await res.json();
          for (const r of rows) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="padding:6px;border-bottom:1px solid var(--border);">${r.id}</td><td style="padding:6px;border-bottom:1px solid var(--border);">${escapeHTML(r.source_name || '')}</td><td style="padding:6px;border-bottom:1px solid var(--border);">${escapeHTML(r.content_type || '')}</td>`;
            body.appendChild(tr);
          }
        } catch (e) {
          body.innerHTML = `<tr><td colspan="3" class="muted">${e.message}</td></tr>`;
        }
      }

      document.getElementById('uploadBtn').addEventListener('click', uploadFiles);
      document.getElementById('ragRefresh').addEventListener('click', () => loadRag().catch(e => alert(e.message)));
      // Drag & drop support
      const dz = document.getElementById('dropZone');
      dz.addEventListener('dragover', (ev) => { ev.preventDefault(); dz.style.background = 'rgba(255,255,255,0.02)'; });
      dz.addEventListener('dragleave', (ev) => { ev.preventDefault(); dz.style.background = 'transparent'; });
      dz.addEventListener('drop', async (ev) => {
        ev.preventDefault(); dz.style.background = 'transparent';
        const items = ev.dataTransfer.files || [];
        if (!items.length) return;
        const input = document.getElementById('fileInput');
        // populate file input for user visibility (some browsers disallow programmatic FileList; skip)
        try { input.files = items; } catch(_){}
        await uploadFiles();
      });

      // Load RAG sources after initial boot
      try { await loadRag(); } catch(_){}
    })();
  </script>
</body>
</html>
