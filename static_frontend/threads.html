<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Your Threads — Places in Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/static/pit-favicon-mark.ico" sizes="any" />
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png" />
  <link rel="manifest" href="/static/site.webmanifest" />
  <meta name="theme-color" content="#0b1020" />
  <link href="/static/style.css?v=brand-7" rel="stylesheet" />
</head>
<body>
  <div class="wrap">
    <div class="banner">
      <div class="brand-side">
        <div class="brand-mark">
          <img src="/static/icon-192.png" alt="Places in Time" />
        </div>
        <div class="brand-title">
          <h1>Places in Time</h1>
          <div class="muted" id="user-label">—</div>
        </div>
      </div>
      <div class="banner-actions">
        <button id="logout-btn" class="btn btn-danger">Log out</button>
      </div>
    </div>

    <div class="grid">
      <aside class="card panel">
        <div class="row" style="margin-bottom:8px;">
          <button id="new-thread-btn" class="btn btn-primary">New Thread</button>
        </div>
        <div id="threads" class="stack"></div>
      </aside>

      <main class="card chat-card">
        <div class="chat-header">
          <div class="controls">
            <input id="thread-title" placeholder="New thread" />
            <button id="save-title-btn" class="btn">Save Title</button>
          </div>

          <div class="figure-hero">
            <img id="figure-hero-img" class="figure-hero-img" src="/static/icon-192.png" alt="">
            <div class="figure-hero-text">
              <div class="figure-row">
                <img id="figure-avatar" class="figure-avatar" alt="" src="/static/icon-192.png">
                <div class="figure-name" id="current-figure">Figure: none</div>
                <div class="figure-select">
                  <label class="muted" for="figure-select">Change</label>
                  <select id="figure-select">
                    <option value="">None (generic historian)</option>
                  </select>
                </div>
              </div>
              <p id="figure-desc" class="figure-desc muted"></p>
            </div>
          </div>

          <div id="status" class="status"></div>
        </div>

        <div id="messages" class="messages"></div>

        <form id="message-form" class="compose">
          <textarea id="message-input" rows="3" placeholder="Type a message…"></textarea>
          <button id="send-btn" type="submit" class="btn">Send</button>
        </form>
      </main>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('access_token');
    const userId = Number(localStorage.getItem('user_id'));
    const username = localStorage.getItem('username') || '';
    if (!token || !userId) window.location.href = '/';

    document.getElementById('user-label').textContent =
      `— signed in as ${username || 'user ' + userId}`;

    async function authFetch(url, options={}) {
      options.headers = { ...(options.headers||{}), 'Authorization': `Bearer ${token}` };
      return fetch(url, options);
    }

    async function upgradeGuestIfNeeded() {
      try {
        const res = await authFetch('/guest/upgrade', { method: 'POST' });
        if (res.ok) {
          console.log('Guest session upgraded');
        }
      } catch (e) {
        console.log('No guest session to upgrade');
      }
    }

    async function loadThreads() {
      const res = await authFetch(`/threads/user/${userId}`);
      if (!res.ok) return;
      const threads = await res.json();
      const container = document.getElementById('threads');
      container.innerHTML = '';
      threads.forEach(t => {
        const el = document.createElement('div');
        el.className = 'thread-item';
        el.textContent = `${t.title} (#${t.id})`;
        el.addEventListener('click', () => selectThread(t.id));
        container.appendChild(el);
      });
    }

    async function selectThread(threadId) {
      const res = await authFetch(`/threads/${threadId}/messages`);
      if (!res.ok) return;
      const msgs = await res.json();
      const container = document.getElementById('messages');
      container.innerHTML = '';
      msgs.forEach(m => {
        const div = document.createElement('div');
        div.className = 'msg ' + m.role;
        div.textContent = `${m.role}: ${m.message}`;
        container.appendChild(div);
      });
    }

    document.getElementById('logout-btn').onclick = () => {
      localStorage.clear();
      window.location.href = '/';
    };

    document.getElementById('message-form').onsubmit = async e => {
      e.preventDefault();
      const msg = document.getElementById('message-input').value.trim();
      if (!msg) return;
      await authFetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, message: msg })
      });
      await loadThreads();
    };

    (async function init() {
      await upgradeGuestIfNeeded();
      await loadThreads();
    })();
  </script>
</body>
</html>
