<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Guest Chat · Places in Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/static/pit-favicon-mark.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <meta name="theme-color" content="#0b1020">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/style.css?v=brand-9" />
  <style>
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);max-width:520px;width:92%;padding:18px}
    .modal h3{margin:0 0 .25rem 0}
    .modal p{margin:.25rem 0 1rem 0;color:var(--muted)}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner">
      <div class="brand-side">
        <div class="brand-mark">
          <img src="/static/icon-192.png" alt="Places in Time">
        </div>
        <div class="brand-title">
          <h1>Places in Time</h1>
          <div class="muted">Guest Chat</div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap-page">
    <div class="figure-hero card">
      <img id="guest-figure-img" class="figure-hero-img" src="/static/icon-192.png" alt="">
      <div class="figure-hero-text">
        <h2 id="guest-figure-name">Loading…</h2>
        <p id="guest-figure-desc" class="figure-desc muted"></p>
      </div>
    </div>

    <div class="card">
      <div id="messages" class="messages" aria-live="polite" aria-atomic="false"></div>
      <div class="row">
        <textarea id="input" placeholder="Ask your question…" autocomplete="off"></textarea>
        <button id="send">Send</button>
      </div>
    </div>

    <div id="status" class="status"></div>
  </div>

  <div id="limit-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="limit-title">
    <div class="modal">
      <h3 id="limit-title">Create a free account</h3>
      <p>You’ve reached the guest limit. Register to continue this conversation and save your threads.</p>
      <div class="actions">
        <button id="later-btn" class="btn">Maybe later</button>
        <button id="go-login-btn" class="btn btn-primary">Register / Log in</button>
      </div>
    </div>
  </div>

  <script>
    function getSlugFromPath() {
      const m = window.location.pathname.match(/^\/guest\/([^/?#]+)/i);
      return m ? decodeURIComponent(m[1]) : null;
    }
    function formatSlugToName(slug) {
      if (!slug) return null;
      const romans = new Set(["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX"]);
      return slug.split("-").map(part => {
        const bare = part.replace(/[^a-z0-9]/gi, "");
        const upper = bare.toUpperCase();
        if (romans.has(upper)) return upper + part.slice(bare.length);
        return part.charAt(0).toUpperCase() + part.slice(1);
      }).join(" ").replace(/\s+,/g, ",");
    }
    function cleanDesc(s) {
      const t = String(s || "").trim();
      if (!t) return "";
      return t
        .replace(/^You are .*?\.\s*/i, "")
        .replace(/^Act as .*?\.\s*/i, "")
        .replace(/\n{2,}/g, "\n")
        .split("\n")[0]
        .trim();
    }
    async function fetchBio(slug) {
      try {
        const r = await fetch(`/figures/${encodeURIComponent(slug)}/bio`);
        if (r.ok) {
          const j = await r.json();
          return cleanDesc(j.description || "");
        }
      } catch (_) {}
      return "";
    }
    async function fetchFigure(slug) {
      try {
        const r = await fetch(`/figures/${encodeURIComponent(slug)}`);
        if (r.ok) return r.json();
      } catch (_) {}
      return null;
    }

    const slug = getSlugFromPath();
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const heroImg = document.getElementById('guest-figure-img');
    const heroName = document.getElementById('guest-figure-name');
    const heroDesc = document.getElementById('guest-figure-desc');
    const modal = document.getElementById('limit-modal');
    const laterBtn = document.getElementById('later-btn');
    const goLoginBtn = document.getElementById('go-login-btn');

    let started = false;
    let figureDisplayName = null;
    let qaCount = 0;

    function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }
    function setStatus(msg, cls){ statusEl.className = 'status' + (cls ? ' ' + cls : ''); statusEl.textContent = msg || ''; }
    function append(role, text){
      const div = document.createElement('div');
      div.className = role === 'user' ? 'msg-user' : 'msg-assistant';
      div.textContent = text;
      messagesEl.appendChild(div);
      scrollToBottom();
    }
    function disableInput(d){ inputEl.disabled = d; sendBtn.disabled = d; }
    function openModal(){ modal.style.display = 'flex'; }
    function closeModal(){ modal.style.display = 'none'; }

    function setHero(imgUrl, name, desc){
      const fallback = '/static/icon-192.png';
      const fallback2 = '/static/logo.png';
      heroImg.src = imgUrl || fallback;
      heroImg.onerror = function(){ this.onerror=null; this.src=fallback; this.onerror=()=>{ this.src=fallback2; }; };
      heroName.textContent = name || 'Guest figure';
      heroDesc.textContent = desc || '';
      document.title = name ? `Guest Chat · ${name}` : 'Guest Chat · Places in Time';
    }

    async function startGuest() {
      if (!slug) {
        setHero('', 'Guest Chat', '');
        setStatus('Missing figure slug. Use /guest/{slug}.', 'err');
        disableInput(true);
        return;
      }
      if (started) return;

      const [fig, bio] = await Promise.all([fetchFigure(slug), fetchBio(slug)]);
      const name = (fig && (fig.name || formatSlugToName(slug))) || formatSlugToName(slug);
      const imageUrl = fig && fig.image_url ? fig.image_url : '';
      const desc = bio || (fig && (fig.description || fig.summary || fig.persona_prompt || "")) || "";
      figureDisplayName = name;
      setHero(imageUrl, name, cleanDesc(desc));

      setStatus('Starting session…');
      try {
        const res = await fetch(`/guest/start/${encodeURIComponent(slug)}`, {
          method: 'POST',
          credentials: 'include'
        });
        if (!res.ok) {
          setStatus(`Error ${res.status}: Failed to start session.`, 'err');
          disableInput(true);
          return;
        }
        setStatus('Session ready.');
        started = true;
        disableInput(false);
      } catch (e) {
        setStatus('Network error while starting session.', 'err');
        disableInput(true);
      }
    }

    async function ask() {
      const text = (inputEl.value || '').trim();
      if (!text || !started) return;

      if (qaCount >= 3) {
        openModal();
        return;
      }

      append('user', text);
      inputEl.value = '';
      disableInput(true);
      setStatus(`${figureDisplayName || 'The historian'} is thinking…`);
      try {
        const res = await fetch('/guest/ask', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        if (!res.ok) {
          setStatus(`Error ${res.status}: Unable to get an answer.`, 'err');
          disableInput(false);
          return;
        }
        const data = await res.json();
        append('assistant', data.answer || '(no answer)');
        qaCount += 1;
        setStatus('', '');
        disableInput(false);
        inputEl.focus();
      } catch (e) {
        setStatus('Network error. Please try again.', 'err');
        disableInput(false);
      }
    }

    sendBtn.addEventListener('click', ask);
    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); } });
    laterBtn.addEventListener('click', () => { closeModal(); });
    goLoginBtn.addEventListener('click', () => { window.location.href = '/'; });

    startGuest();
  </script>
</body>
</html>
